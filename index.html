<!-- ... all your previous HTML and CSS remains unchanged ... -->

<script>
  const voiceButton = document.getElementById("voiceButton");

  voiceButton.onclick = async () => {
    // Get Polly audio from your API
    const pollyResponse = await fetch('https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/polly', {
      method: 'POST',
      body: JSON.stringify({ text: "Hello, I am your AI assistant. I will help you fill this form. Can I get your name?" }),
      headers: { 'Content-Type': 'application/json' }
    });

    const audioData = await pollyResponse.json();
    const audioSrc = "data:audio/mp3;base64," + audioData.audio;

    const audio = new Audio(audioSrc);
    audio.play();

    // Wait for Polly audio to finish (rough estimate)
    setTimeout(() => {
      startTranscription();
    }, 5000);
  };

  async function startTranscription() {
    const res = await fetch('https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/transcribe-url');
    const { transcribe_url } = await res.json();

    const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(mediaStream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);

    const ws = new WebSocket(transcribe_url);
    ws.binaryType = 'arraybuffer';

    ws.onopen = () => {
      source.connect(processor);
      processor.connect(audioContext.destination);

      processor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        const buffer = convertFloat32ToInt16(input);
        ws.send(buffer);
      };
    };

    // âœ… Fixed onmessage block
    ws.onmessage = (msg) => {
      try {
        const decoder = new TextDecoder("utf-8");
        const decoded = decoder.decode(msg.data);
        const message = JSON.parse(decoded);

        const transcript = message.Transcript?.Results?.[0]?.Alternatives?.[0]?.Transcript;
        if (transcript) {
          fillFormField(transcript);
        }
      } catch (err) {
        console.error("Error parsing message:", err);
      }
    };

    ws.onerror = console.error;
  }

  function convertFloat32ToInt16(buffer) {
    let l = buffer.length;
    const buf = new Int16Array(l);
    while (l--) buf[l] = Math.min(1, buffer[l]) * 0x7FFF;
    return buf.buffer;
  }

  let currentField = 0;
  const fields = ['name', 'email', 'phone', 'address'];

  function fillFormField(text) {
    const field = document.getElementById(fields[currentField]);
    if (field && !field.value) {
      field.value = text;
      currentField++;
      if (currentField < fields.length) {
        // Speak next question
        fetch('https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/polly', {
          method: 'POST',
          body: JSON.stringify({ text: `Can I get your ${fields[currentField].replace('_', ' ')}?` }),
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          const audio = new Audio("data:audio/mp3;base64," + data.audio);
          audio.play();
        });
      }
    }
  }
</script>
