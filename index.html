<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice-Based Contact Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f8f8;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .container {
      background-color: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      width: 400px;
    }

    label {
      font-weight: bold;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: #4285F4;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }

    #voiceButton {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #007bff;
      border: none;
      cursor: pointer;
      animation: buzz 1s infinite alternate;
    }

    @keyframes buzz {
      0% { transform: rotate(-5deg); }
      100% { transform: rotate(5deg); }
    }

    #voiceIcon {
      width: 30px;
      height: 30px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Contact Form</h2>
  <form id="contactForm">
    <label for="name">Name*</label>
    <input type="text" id="name" required>
    <label for="email">Email*</label>
    <input type="email" id="email" required>
    <label for="phone">Phone</label>
    <input type="tel" id="phone">
    <label for="address">Address</label>
    <textarea id="address" rows="3"></textarea>
    <button type="submit">Submit</button>
  </form>
</div>

<button id="voiceButton">
  <img id="voiceIcon" src="https://img.icons8.com/ios-filled/50/ffffff/microphone.png" />
</button>

<script>
  const voiceButton = document.getElementById("voiceButton");
  let ws;

  voiceButton.onclick = async () => {
    // Polly Intro
    const pollyResponse = await fetch('https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/polly', {
      method: 'POST',
      body: JSON.stringify({ text: "Hello, I am your AI assistant. I will help you fill this form. Please begin by saying your name." }),
      headers: { 'Content-Type': 'application/json' }
    });
    const audioData = await pollyResponse.json();
    const audioSrc = "data:audio/mp3;base64," + audioData.audio;
    const audio = new Audio(audioSrc);
    audio.play();
    setTimeout(() => startTranscription(), 5000);
  };

  async function startTranscription() {
    const res = await fetch('https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/transcribe-url');
    const { transcribe_url } = await res.json();
    console.log("WebSocket URL:", transcribe_url);

    const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(mediaStream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);

    ws = new WebSocket(transcribe_url);
    ws.binaryType = 'arraybuffer';

    ws.onopen = () => {
      console.log("WebSocket open");
      source.connect(processor);
      processor.connect(audioContext.destination);

      processor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        const buffer = convertFloat32ToInt16(input);
        ws.send(buffer);
      };
    };

    ws.onmessage = (msg) => {
      try {
        const decoder = new TextDecoder("utf-8");
        const decoded = decoder.decode(msg.data);
        const message = JSON.parse(decoded);
        const transcript = message.Transcript?.Results?.[0]?.Alternatives?.[0]?.Transcript;
        if (transcript) {
          console.log("Transcript:", transcript);
          fillFormSmart(transcript.toLowerCase());
        }
      } catch (err) {
        console.error("Message parsing error:", err);
      }
    };

    ws.onerror = console.error;
  }

  function convertFloat32ToInt16(buffer) {
    let l = buffer.length;
    const buf = new Int16Array(l);
    while (l--) buf[l] = Math.min(1, buffer[l]) * 0x7FFF;
    return buf.buffer;
  }

  function fillFormSmart(text) {
    if (text.includes("name is")) {
      const name = text.split("name is")[1].trim().split(" ")[0];
      document.getElementById("name").value = name;
    } else if (text.includes("email") || text.includes("mail")) {
      const email = text.split("is")[1]?.trim().replace(" at ", "@").replace(" dot ", ".").replace(/\s/g, "");
      if (email) document.getElementById("email").value = email;
    } else if (text.includes("phone") || text.includes("number")) {
      const phone = text.replace(/\D/g, "");
      if (phone.length >= 10) document.getElementById("phone").value = phone.slice(0, 10);
    } else if (text.includes("address is")) {
      const addr = text.split("address is")[1];
      document.getElementById("address").value = addr?.trim();
    }
  }
</script>
</body>
</html>
