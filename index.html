<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Contact Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-top: 5px;
    }
    #voiceButton {
      position: fixed;
      bottom: 30px;
      left: 30px;
      background-color: #007bff;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      color: white;
      font-size: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Contact Form</h2>
  <div class="form-group">
    <label for="name">Name*</label>
    <input type="text" id="name">
  </div>
  <div class="form-group">
    <label for="email">Email*</label>
    <input type="email" id="email">
  </div>
  <div class="form-group">
    <label for="phone">Phone</label>
    <input type="text" id="phone">
  </div>
  <div class="form-group">
    <label for="address">Address</label>
    <textarea id="address"></textarea>
  </div>
  <button>Submit</button>
</div>
<button id="voiceButton">ðŸŽ¤</button>

<script>
const fields = ['name', 'email', 'phone', 'address'];
let currentField = 0;

const voiceButton = document.getElementById("voiceButton");
voiceButton.onclick = async () => {
  voiceButton.style.boxShadow = "0 0 20px 5px #00f";

  const pollyResponse = await fetch('https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/polly', {
    method: 'POST',
    body: JSON.stringify({ text: "Hello, I am your AI assistant. I will help you fill this form. Can I get your name?" }),
    headers: { 'Content-Type': 'application/json' }
  });

  const audioData = await pollyResponse.json();
  const audioSrc = "data:audio/mp3;base64," + audioData.audio;
  const audio = new Audio(audioSrc);
  audio.play();

  setTimeout(() => {
    startTranscription();
  }, 5000);
};

async function startTranscription() {
  const res = await fetch('https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/transcribe-url');
  const { transcribe_url } = await res.json();

  const ws = new WebSocket(transcribe_url);
  ws.binaryType = 'arraybuffer';
  console.log("WebSocket URL:", transcribe_url);

  const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const audioContext = new AudioContext();
  const source = audioContext.createMediaStreamSource(mediaStream);
  const processor = audioContext.createScriptProcessor(4096, 1, 1);

  ws.onopen = () => {
    console.log("WebSocket open");
    source.connect(processor);
    processor.connect(audioContext.destination);
    processor.onaudioprocess = (e) => {
      const input = e.inputBuffer.getChannelData(0);
      const buffer = convertFloat32ToInt16(input);
      if (ws.readyState === WebSocket.OPEN) ws.send(buffer);
    };
  };

  ws.onmessage = (msg) => {
    try {
      let decoded;

      if (typeof msg.data === "string") {
        decoded = msg.data;
      } else {
        const decoder = new TextDecoder("utf-8");
        decoded = decoder.decode(msg.data);
        if (!decoded.trim().startsWith('{')) return;
      }

      const message = JSON.parse(decoded);
      const transcript = message.Transcript?.Results?.[0]?.Alternatives?.[0]?.Transcript;
      if (transcript) {
        console.log("Transcript:", transcript);
        fillFormSmart(transcript);
      }
    } catch (err) {
      console.error("Message parsing error:", err);
    }
  };

  ws.onerror = console.error;
}

function convertFloat32ToInt16(buffer) {
  let l = buffer.length;
  const buf = new Int16Array(l);
  while (l--) buf[l] = Math.min(1, buffer[l]) * 0x7FFF;
  return buf.buffer;
}

function fillFormSmart(transcript) {
  transcript = transcript.toLowerCase();

  if (transcript.includes("my name is") || transcript.split(" ").length === 1) {
    const name = transcript.replace("my name is", "").trim();
    if (!document.getElementById('name').value) {
      document.getElementById('name').value = name;
      askNext("email");
      return;
    }
  }

  if (transcript.includes("email is") || transcript.includes("at")) {
    const email = transcript.replace("email is", "").trim();
    if (!document.getElementById('email').value) {
      document.getElementById('email').value = email;
      askNext("phone");
      return;
    }
  }

  if (!document.getElementById(fields[currentField]).value) {
    document.getElementById(fields[currentField]).value = transcript;
    currentField++;
    if (currentField < fields.length) {
      askNext(fields[currentField]);
    }
  }
}

function askNext(field) {
  fetch('https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/polly', {
    method: 'POST',
    body: JSON.stringify({ text: `Can I get your ${field}?` }),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(res => res.json())
  .then(data => {
    const audio = new Audio("data:audio/mp3;base64," + data.audio);
    audio.play();
  });
}
</script>
</body>
</html>
