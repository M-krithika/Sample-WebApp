<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Assistant Form</title>
  <style>
    .buzz-button {
      animation: buzz 0.3s linear infinite alternate;
    }

    @keyframes buzz {
      0% { transform: translateX(-2px); }
      100% { transform: translateX(2px); }
    }
  </style>
</head>
<body>
  <h1>Contact Form</h1>

  <form id="contactForm">
    <label for="name">Name*</label><br>
    <input type="text" id="name" required><br><br>

    <label for="email">Email ID*</label><br>
    <input type="email" id="email" required><br><br>

    <label for="phone">Phone Number</label><br>
    <input type="tel" id="phone"><br><br>

    <label for="address">Address</label><br>
    <textarea id="address"></textarea><br><br>

    <button type="submit">Submit</button>
  </form>

  <button id="voiceButton" class="buzz-button" style="position: fixed; bottom: 20px; left: 20px;">ðŸŽ¤</button>
  <audio id="audioPlayer" controls style="display:none;"></audio>

  <script>
    const pollyApiUrl = "https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/polly";
    const transcribeUrlApi = "https://n4kgojcoui.execute-api.eu-west-1.amazonaws.com/transcribe-url";

    const audioPlayer = document.getElementById("audioPlayer");
    const voiceButton = document.getElementById("voiceButton");

    voiceButton.addEventListener("click", async () => {
      // Step 1: Speak welcome message from Polly
      const welcomeMessage = "Hello, I am your AI assistant. I will help you fill this form. Can I get your name?";
      await speakFromPolly(welcomeMessage);

      // Step 2: Get Transcribe WebSocket URL
      const response = await fetch(transcribeUrlApi);
      const { transcribe_url } = await response.json();

      // Step 3: Start real-time transcription from microphone
      startTranscription(transcribe_url);
    });

    async function speakFromPolly(text) {
      const response = await fetch(pollyApiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });

      const data = await response.json();
      if (data.audio) {
        const audioBlob = b64ToBlob(data.audio, "audio/mp3");
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPlayer.src = audioUrl;
        audioPlayer.style.display = "block";
        await audioPlayer.play();
      }
    }

    function b64ToBlob(base64, mime) {
      const byteChars = atob(base64);
      const byteArrays = [];
      for (let offset = 0; offset < byteChars.length; offset += 512) {
        const slice = byteChars.slice(offset, offset + 512);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        byteArrays.push(new Uint8Array(byteNumbers));
      }
      return new Blob(byteArrays, { type: mime });
    }

    async function startTranscription(wsUrl) {
      const socket = new WebSocket(wsUrl);
      const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm;codecs=opus' });

      socket.onopen = () => {
        mediaRecorder.start(250); // Send every 250ms chunk
        mediaRecorder.ondataavailable = event => {
          if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
            event.data.arrayBuffer().then(buffer => {
              socket.send(buffer);
            });
          }
        };
      };

      socket.onmessage = event => {
        const message = JSON.parse(event.data);
        if (message.Transcript && message.Transcript.Results.length > 0) {
          const result = message.Transcript.Results[0];
          if (result.IsPartial === false && result.Alternatives.length > 0) {
            const transcript = result.Alternatives[0].Transcript.toLowerCase();
            console.log("Transcript:", transcript);
            fillFormField(transcript);
          }
        }
      };
    }

    function fillFormField(transcript) {
      const form = document.getElementById("contactForm");
      if (!form.name.value) {
        form.name.value = transcript;
        speakFromPolly("Thanks. Can I get your email address?");
      } else if (!form.email.value) {
        form.email.value = transcript;
        speakFromPolly("Great. What is your phone number?");
      } else if (!form.phone.value) {
        form.phone.value = transcript;
        speakFromPolly("Lastly, please tell me your address.");
      } else if (!form.address.value) {
        form.address.value = transcript;
        speakFromPolly("Thank you. All details are captured.");
      }
    }
  </script>
</body>
</html>
